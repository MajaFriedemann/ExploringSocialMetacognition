Bootstrap: library
From: ubuntu:18.04

%post
	# Here we put scripts to run immediatley after initialisation of the OS

	# Update Ubuntu package repos
	echo "deb http://gb.archive.ubuntu.com/ubuntu bionic main restricted" >> /etc/apt/sources.list
	echo "deb http://gb.archive.ubuntu.com/ubuntu bionic universe" >> /etc/apt/sources.list
	echo "deb http://gb.archive.ubuntu.com/ubuntu bionic-updates multiverse" >> /etc/apt/sources.list
	echo "deb http://gb.archive.ubuntu.com/ubuntu bionic-backports main restricted universe multiverse" >> /etc/apt/sources.list
	echo "deb http://gb.archive.ubuntu.com/ubuntu bionic-security main restricted" >> /etc/apt/sources.list

  # Install packages
  apt-get update
  apt-get install -y libssl-dev libgsl-dev libxml2-dev libcurl4-openssl-dev git r-base r-base-dev r-cran-littler r-cran-rjags r-cran-curl r-cran-car r-cran-mvtnorm r-cran-mcmcpack r-cran-openssl r-cran-xml2 pandoc
  
  # Clone git repository
  git clone https://github.com/oxacclab/ExploringSocialMetacognition ESM
  
  # Run setup R script
  r /ESM/analysis/ACv2/src/install-packages.R
  
%runscript
  # Commands to run when called
  echo "Container created $NOW"
  echo "Arguments: $*"
  exec echo "$@"
  echo "Knitting analysis script..."
  r -e 'rmarkdown::render("/ESM/analysis/ACv2/directBenevolenceContext_v0.0.1.Rmd")'
  
  cat /ESM/analysis/ACv2/directBenevolenceContext_v0.0.1.html
  
%test
  # Check whether R installed properly
  
%labels
  Author matt.jaquiery@psy.ox.ac.uk
  Version v0.0.2
  Date 2019-12-29
  
%help
  This container should provide a reproducible version of the study at a given point in its history. It should provide a useable version of the study on a local webserver, and access to the analysis scripts run in an environment identical to the one used for the write-up of the project. 
  By default it will print out an HTML file freshly generated from Rmarkdown code.