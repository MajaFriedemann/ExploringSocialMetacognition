<!DOCTYPE html>
<html lang="en">
<head>
    <title>Advisor Choice Experiment</title>

    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="../src/sha1.js"></script>
    <script src="../src/bowser.min.js"></script>

    <!--Custom HTML components-->
    <script src="../src/customElements/InstructionDiv.js"></script>
    <script src="../src/customElements/HelpDiv.js"></script>
    <script src="../src/customElements/ResponseWidget.js"></script>
    <!--/ Custom HTML components-->

    <link rel="stylesheet" type="text/css" href="../style/structure.css"/>
    <link rel="stylesheet" type="text/css" href="../style/advisorsGroups.css"/>

    <!-- Templates -->
    <template id="advisor-key">
        <div class="advisor-key-row">
            <div class="marker"></div>
            <span>Advisor Name</span>
            <esm-help data-group="interface" class="left">
                This <em>tag</em> shows details for one of your advisors. The background colour shows you their group, and the <em>marker</em> shows you the colour used to indicate their advice.
            </esm-help>
        </div>
    </template>

    <template id="instr-intro">
        <esm-instruction>
            <esm-instruction-page>
                <h1>Welcome</h1>
                <img src="https://cdn.instructables.com/FMU/YSFR/IDRP7INH/FMUYSFRIDRP7INH.LARGE.jpg" alt="Coin jar" style="float: right; height: 250px;"/>
                <p>This experiment is pretty straightforward. You'll see several jars full of coins, which look the one on the right.</p>
                <p>Your task is to use the response bar at the bottom of the screen to indicate how much you think the coins in the jar are worth, and how sure you are about your estimate.</p>
            </esm-instruction-page>
        </esm-instruction>
    </template>
    <template id="instr-practice">
        <esm-instruction>
            <esm-instruction-page>
                <h1>Practice</h1>
                <p>You will now have an opportunity to practice the task. You will get feedback on your performance while you are doing the practice, and you'll be told how well you did overall once you have done all the practice rounds.</p>
                <p>When you get the answer within &pound;0.25 of the correct value you'll see the screen go pink. Where you are more than &pound;0.25 away from the correct answer you'll see the screen turn grey.</p>
            </esm-instruction-page>
        </esm-instruction>
    </template>
    <template id="instr-final">
        <esm-instruction>
            <esm-instruction-page>
                <h1>Main experiment</h1>
                <p>You are now ready to begin the main experiment.</p>
                <p>Please make sure you are in a quiet environment where you can concentrate properly.</p>
            </esm-instruction-page>
            <esm-instruction-page>
                <h1>Main experiment</h1>
                <p>If you are still unsure of how the study works, you can go through the tutorial again by closing the page and relaunching it from the link you were provided.</p>
                <p>If you're happy with how it works, let's go!</p>
            </esm-instruction-page>
        </esm-instruction>
    </template>
    <template id="instr-debrief">
        <esm-instruction data-no-buttons="true">
            <esm-instruction-page>
                <h1>Thanks!</h1>
                <p>Thank you for completing my study.</p>
                <p>You did pretty well. I haven't calculated how well, yet, but trust me, pretty well.</p>
            </esm-instruction-page>
        </esm-instruction>
    </template>
</head>
<body tabindex="0">
<div class="content-wrapper">
    <div id="content">
        <div class="progress-bar">
            <div class="outer">
                <div class="inner"></div>
            </div>
            <esm-help data-group="interface" class="bottom">
                The <em>progress bar</em> shows how far through the study you are.
            </esm-help>
        </div>
        <div class="frame top">
            <div class="left">
                <div class="advisor-key-row group-bg-2 group-border-2">
                    You are in Group 2
                    <esm-help data-group="interface" class="right">
                        This <em>tag</em> shows which group you've been assigned to.
                    </esm-help>
                </div>
            </div>
            <div class="middle">
                <div id="stimulus"></div>
                <div id="prompt">Prompt text</div>
                <esm-help data-group="interface">
                    This is the <em>stimulus</em> you have to respond to. Below is the <em>prompt</em> area which tells you how to respond and provides further information.
                </esm-help>
            </div>
            <div class="right">
                <div class="advisor-key-row advisor-1 group-bg-2 group-border-2">
                    <div class="marker advisor-bg-1 advisor-border-1"></div>
                    Advisor #25
                    <esm-help data-group="interface" class="left">
                        This <em>tag</em> shows details for one of your advisors. The background colour shows you their group, and the <em>marker</em> shows you the colour used to indicate their advice.
                    </esm-help>
                </div>
                <div class="advisor-key-row advisor-2 group-bg-1 group-border-1">
                    <div class="marker advisor-bg-2 advisor-border-2"></div>
                    Advisor #352
                    <esm-help data-group="interface" class="left">
                        This <em>tag</em> shows details for one of your advisors. The background colour shows you their group, and the <em>marker</em> shows you the colour used to indicate their advice.
                    </esm-help>
                </div>
            </div>
        </div>
        <div class="frame bottom">
            <esm-response-widget id="response-panel" class="cloak" data-min="1.00" data-max="5.00" data-prefix="" data-suffix="" data-decimals="2">
                <div class="response-hBar">
                    <div class="response-label left">&pound;1.00</div>
                    <div class="response-label right">&pound;5.00</div>
                    <div class="response-widget">
                        <div class="response-vBar cloak group-bg-gradient-2">
                            <div class="response-label top">certain</div>
                            <div class="response-label bottom">guess</div>
                            <div class="response-marker group-bg-2">3.00</div>
                        </div>
                    </div>
                    <div class="response-marker correct feedback">&bigstar;</div>
                </div>
            </esm-response-widget>
            <esm-help data-group="interface" data-parent-click-closes="false" class="top">
                This <em>response panel</em> allows you to indicate your answer. When enabled, the marker will follow your mouse movements. <strong>Click</strong> or <strong>Tap</strong> to indicate your answer. You will then see the vertical bar which allows you to indicate your <em>confidence</em> in your answer. Again, <strong>Click</strong> or <strong>Tap</strong> to indicate your <em>confidence</em>.
            </esm-help>
        </div>
        <button onclick="toggleHelp()" style="
        position: absolute;
        font-size: 1em;
        font-weight: bold;
        margin: 0.3em;
        padding: 0.3em;
        border-radius: 1em;
        width: 2em;
        height: 2em;
        border: 1px solid black;
        background-color: transparent;
        bottom: 0;
        right: 0;">?</button>
        <div id="instructions">
            Instructions
        </div>
        <div id="training-instructions" class="hidden">
            Click or Touch the yellow box to move on...
        </div>
    </div>
</div>
<script type="text/javascript">
    /**
     * Toggle between help enabled/disabled.
     */
    function toggleHelp() {
        document.querySelectorAll("esm-help").forEach((elm) => elm.toggle());

        event.currentTarget.style.backgroundColor =
            event.currentTarget.style.backgroundColor === "transparent"?
                "yellow" : "transparent";
    }
</script>
<script type="module">
    "use strict";

    import {Trial, AdvisedTrial} from "../src/modules/Trial.js";
    import Advisor from "../src/modules/Advisor.js";

    class Study {

        constructor(trialCount, trialCountPractice) {
            this.trialCount = trialCount;
            this.trialCountPractice = trialCountPractice;
        }

        async ITI() {
            let elm = document.querySelector("#content");
            elm.classList.add("ITI");
            return new Promise((resolve) =>
                setTimeout(() => {
                        elm.classList.remove("ITI");
                        resolve();
                    }, 500
                )
            );
        }

        /**
         * Set the content of the instructions div to be a copy of an esm-instruction template.
         * @param newTemplateId {string} id of the new template to use for instructions
         * @param [callback] {function(buttonName, event)} function to use as the callback for instruction buttons. By default simply hide the instruction div.
         */
        static updateInstructions(newTemplateId, callback) {
            let instr = document.getElementById("instructions");

            if(typeof callback !== "function")
                callback = (name, event) => {
                    console.log(name);
                };

            // Clear old instructions
            instr.innerHTML = "";

            // Add new
            instr.appendChild(
                document.importNode(
                    document.getElementById(newTemplateId).content,
                    true));

            instr.querySelector("esm-instruction").callback = callback;

            instr.classList.remove("hidden");
        }

        async intro() {
            return new Promise(function(resolve) {
                let data = [];
                Study.updateInstructions("instr-intro",
                    (name) => {
                    let now = new Date().getTime();
                        data.push({name, now});
                        if(name === "end")
                            resolve(data);
                    });
            });
        }

        async training() {

            let study = this;

            // Show navigation cues
            let instr = document.getElementById("training-instructions");
            instr.classList.remove("hidden");

            return new Promise(async function(resolve) {
                // Spacebar moves onwards
                const gotoNextStep = function(target) {
                    return(new Promise((resolve)=> {
                        function next() {
                            target.removeEventListener("click", next);
                            resolve();
                        }
                        target.addEventListener("click", next);
                    }))
                };

                let blueprint = {};
                blueprint.stim = new Image();
                blueprint.stim.src = "https://cdn.instructables.com/FMU/YSFR/IDRP7INH/FMUYSFRIDRP7INH.LARGE.jpg";
                blueprint.prompt = [];
                AdvisedTrial.phases.forEach((p)=>blueprint.prompt[p] = "How much are the coins worth?");
                blueprint.prompt["cleanup"] = "";
                blueprint.prompt["end"] = "";
                blueprint.displayFeedback = study.displayFeedback;
                let T = new Trial(blueprint);

                let help = document.querySelector(".progress-bar esm-help");
                help.show();

                await gotoNextStep(help);

                help.hide();

                T.begin(false);
                T.showStim(false);
                help = document.querySelector("#stimulus ~ esm-help");
                help.show();

                await gotoNextStep(help);

                help.hide();
                instr.innerHTML = "Enter an estimate and rate your confidence to move on...";
                instr.style.bottom = "unset";
                instr.style.top = "2em";
                let data = T.hideStim(false);

                help = document.querySelector("esm-response-widget ~ esm-help");
                help.show();

                await T.getResponse()
                    .then((data) => T.processResponse(data));

                help.hide();

                // Hide navigation cues
                instr.classList.add("hidden");
                resolve(data);
            });
        }

        async moreInstructions() {
            return new Promise(function(resolve) {
                let data = [];
                Study.updateInstructions("instr-practice",
                    (name) => {
                        let now = new Date().getTime();
                        data.push({name, now});
                        if(name === "end")
                            resolve(data);
                    });
            });
        }

        async practice() {
            let data = [];
            for(let i = 0; i < this.trialCountPractice; i++) {
                // Define the trial
                let blueprint = {};
                blueprint.stim = new Image();
                blueprint.stim.src = "https://cdn.instructables.com/FMU/YSFR/IDRP7INH/FMUYSFRIDRP7INH.LARGE.jpg";
                blueprint.prompt = [];
                Trial.phases.forEach((p)=>blueprint.prompt[p] = "How much are the coins worth?");
                blueprint.prompt["cleanup"] = "";
                blueprint.prompt["end"] = "";
                blueprint.displayFeedback = this.displayFeedback;

                // Run the trial
                data.push(await new Trial(blueprint).run());

                // Inter-trial interval
                await this.ITI();
            }

            return data;
        }

        async finalInstructions() {
            return new Promise(function(resolve) {
                let data = [];
                Study.updateInstructions("instr-final",
                    (name) => {
                        let now = new Date().getTime();
                        data.push({name, now});
                        if(name === "end")
                            resolve(data);
                    });
            });
        }

        async debrief() {
            Study.updateInstructions("instr-debrief");
            return new Promise(function(resolve) {
                setTimeout(resolve, 0, "debrief");
            });
        }

        /**
         * Display the feedback for a trial
         * @param trial {Trial}
         * @return {Promise<*>}
         */
        async displayFeedback(trial) {
            const feedbackDuration = 10000;

            const correctAnswer = 1 + Math.random() * 4;
            const answer = trial.data.responseEstimate;
            const error = Math.abs(answer - correctAnswer);
            const correct = error < .25;

            document.getElementById("content").classList
                .add(correct? "correct" : "incorrect", "feedback");
            document.getElementById("prompt").innerHTML =
                "Actual amount: <span>&pound;" + correctAnswer.toFixed(2) + "</span>";

            const marker = document.querySelector("esm-response-widget .response-marker.correct.feedback");
            const d = document.querySelector("esm-response-widget").valueToProportion(correctAnswer, 1);
            let box = document.querySelector(".response-hBar").getBoundingClientRect();
            marker.style.left =
                (d.estimateProportion * (box.width - box.height) +
                ((box.height - marker.clientWidth) / 2)) + "px";
            box = document.querySelector(".response-vBar").getBoundingClientRect();
            marker.style.top = "calc(" +
                ((1 - d.confidence) * (box.height - marker.clientHeight)) + "px - " +
                "var(--response-vBar-offset))";

            setTimeout(()=> {
                document.getElementById("content").classList
                    .remove(correct? "correct" : "incorrect", "feedback");
                document.getElementById("prompt").innerText = "";
                document.querySelector("esm-response-widget").reset();
            }, feedbackDuration - 10);
            return new Promise((resolve) => {
                setTimeout(resolve, feedbackDuration);
            });
        }

        async run() {
            const data = {
                intro: null,
                training: null,
                instructions: null,
                trials: null,
                debrief: null
            };

            // console.log(await this.intro())
            // console.log(await this.training())
            //console.log(await this.moreInstructions())
            console.log(await this.practice())
            console.log(await this.finalInstructions())

            data.trials = [];
            for(let i = 0; i < this.trialCount; i++) {
                // Define the trial
                let blueprint = {};
                blueprint.stim = new Image();
                blueprint.stim.src = "https://cdn.instructables.com/FMU/YSFR/IDRP7INH/FMUYSFRIDRP7INH.LARGE.jpg";
                blueprint.prompt = [];
                Trial.phases.forEach((p)=>blueprint.prompt[p] = "How much are the coins worth?");
                blueprint.prompt["cleanup"] = "";
                blueprint.prompt["end"] = "";

                // Run the trial
                data.trials.push(await new Trial(blueprint).run());

                // Inter-trial interval
                await this.ITI();
            }

            console.log(await this.debrief())

            this.data = data;

            return this;
        }
    }

    // Procedural stuff

    AdvisedTrial.reset();

    new Study(2, 2).run()
        .then(console.log);

</script>
</body>
</html>