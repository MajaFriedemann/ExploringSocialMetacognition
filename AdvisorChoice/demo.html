<!DOCTYPE html>
<html>
<head>
    <title>Advisor Choice Experiment</title>

    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="../src/sha1.js"></script>
    <script src="../src/bowser.min.js"></script>

    <!--Custom HTML components-->
    <script src="../src/customElements/HelpDiv.js"></script>
    <script src="../src/customElements/ResponseWidget.js"></script>
    <!--/ Custom HTML components-->

    <link rel="stylesheet" type="text/css" href="../style/structure.css"/>
    <link rel="stylesheet" type="text/css" href="../style/advisorsGroups.css"/>

</head>
<body tabindex="0">
<div class="content-wrapper">
    <div id="content">
        <div class="progress-bar">
            <div class="outer">
                <div class="inner"></div>
            </div>
            <esm-help data-group="interface" class="bottom">
                The <em>progress bar</em> shows how far through the study you are.
            </esm-help>
        </div>
        <div class="frame top">
            <div class="left">
                <div class="advisor-key-row group-bg-2 group-border-2">
                    You are in Group 2
                    <esm-help data-group="interface" class="right">
                        This <em>tag</em> shows which group you've been assigned to.
                    </esm-help>
                </div>
            </div>
            <div class="middle">
                <div id="stimulus">
                    <img src="https://cdn.instructables.com/FMU/YSFR/IDRP7INH/FMUYSFRIDRP7INH.LARGE.jpg"/>
                </div>
                <div id="prompt">Prompt text</div>
                <esm-help data-group="interface">
                    This is the <em>stimulus</em> you have to respond to. Below is the <em>prompt</em> area which tells you how to respond and provides further information.
                </esm-help>
            </div>
            <div class="right">
                <div class="advisor-key-row advisor-1 group-bg-2 group-border-2">
                    <div class="marker advisor-bg-1 advisor-border-1"></div>
                    Advisor #25
                    <esm-help data-group="interface" class="left">
                        This <em>tag</em> shows details for one of your advisors. The background colour shows you their group, and the <em>marker</em> shows you the colour used to indicate their advice.
                    </esm-help>
                </div>
                <div class="advisor-key-row advisor-2 group-bg-1 group-border-1">
                    <div class="marker advisor-bg-2 advisor-border-2"></div>
                    Advisor #352
                    <esm-help data-group="interface" class="left">
                        This <em>tag</em> shows details for one of your advisors. The background colour shows you their group, and the <em>marker</em> shows you the colour used to indicate their advice.
                    </esm-help>
                </div>
            </div>
        </div>
        <div class="frame bottom">
            <esm-response-widget id="response-panel" class="cloak" data-min="1.00" data-max="5.00" data-prefix="" data-suffix="" data-decimals="2">
                <div class="response-hBar">
                    <div class="response-label left">&pound;1.00</div>
                    <div class="response-label right">&pound;5.00</div>
                    <div class="response-widget">
                        <div class="response-vBar cloak group-bg-gradient-2">
                            <div class="response-label top">certain</div>
                            <div class="response-label bottom">guess</div>
                            <div class="response-marker group-bg-2">3.00</div>
                        </div>
                    </div>
                </div>
            </esm-response-widget>
            <esm-help data-group="interface" data-parent-click-closes="false" class="top">
                This <em>response panel</em> allows you to indicate your answer. When enabled, the marker will follow your mouse movements. <strong>Click</strong> or <strong>Tap</strong> to indicate your answer. You will then see the vertical bar which allows you to indicate your <em>confidence</em> in your answer. Again, <strong>Click</strong> or <strong>Tap</strong> to indicate your <em>confidence</em>.
            </esm-help>
        </div>
        <button onclick="toggleHelp()" style="
        position: absolute;
        font-size: 1em;
        font-weight: bold;
        margin: 0.3em;
        padding: 0.3em;
        border-radius: 1em;
        width: 2em;
        border: 1px solid black;
        background-color: transparent;
        bottom: 0;
        right: 0;">?</button>
    </div>
</div>
<script type="text/javascript">
    /**
     * Toggle between help enabled/disabled.
     */
    function toggleHelp() {
        document.querySelectorAll("esm-help").forEach((elm) => elm.toggle());

        event.currentTarget.style.backgroundColor =
            event.currentTarget.style.backgroundColor === "transparent"?
                "yellow" : "transparent";
    }
</script>
<script type="module">
    "use strict";

    import {Trial} from "../src/modules/Trial.js";

    // Procedural stuff

    async function intro() {
        console.log("intro")

        return new Promise(function(resolve) {
           setTimeout(resolve, 1, "intro");
        });
    }

    async function training() {
        console.log("training")

        return new Promise(function(resolve) {
            setTimeout(resolve, 500, "training");
        });
    }

    async function moreInstructions() {
        console.log("moreInstructions")

        return new Promise(function(resolve) {
            setTimeout(resolve, 250, "moreInstructions");
        });
    }

    async function runTrials(trials) {
        console.log("runTrials")

        let data = [];
        for (const t of trials)
            await t.run().then((d) => {
                data.push(d);
            });

        return data;
    }

    async function debrief() {
        console.log("debrief")

        return new Promise(function(resolve) {
            setTimeout(resolve, 0, "debrief");
        });
    }

    async function run(trialCount) {
        const data = {
            intro: null,
            training: null,
            instructions: null,
            trials: null,
            debrief: null
        };

        data.intro = await intro();
        data.training = await training();
        data.instructions = await moreInstructions();

        data.trials = [];
        for(let i = 0; i < trialCount; i++)
            data.trials.push(await new Trial().run());

        data.debrief = await debrief();

        return data;
    }

    Trial.reset();

    run(2).then(console.log);

</script>
</body>
</html>